<!doctype html>

<html>

<head>

<title>I MADE A FUN GAME</title>


<link rel="stylesheet" type="text/css" href="./main.css" />


</head>

<body>
  <div id="game">
    <div id="walkthrough-title">lets merc some bad guys</div>
    <div id="room"></div>
    <div id="living-room"></div>


    <img id="protag" src="player-facing-down.png" />
  </div>

<script>
  const roomElm = document.getElementById("room");
  const playerElm = document.getElementById("protag");
  const momElm = document.getElementById("mom");
  const titleElm = document.getElementById("walkthrough-title");
  const gameElm = document.getElementById("game");


  let player = {
      x: 0, 
      y: 0,
      dir: "down"
    };
  let orbImage;
  let orbs = [];

  class Orb {
      kOrbSpeed = 6;


      // the html element (this is technically the shadow)
      $el = null;

      // position variables;
      x = 0;
      y = 0;
      vx = 0;
      vy = 0;

      constructor() {
	this.$el = orbImage.cloneNode(true);
	this.$el.className = "orb";
	gameElm.appendChild(this.$el);
      };

      update() {
	this.x += this.vx * this.kOrbSpeed;
    	this.y += this.vy * this.kOrbSpeed;
    	updateScreenPos(this.$el, this.x, this.y);

    	if ((Date.now() % 300) > 150) {
    	  this.$el.src = "orb1.png";
    	} else {
    	  this.$el.src = "orb2.png";
    	}

      }


  }



  let last_tick = Date.now();
  let delta_time = 0;
  let tick_num = 0;
  function tick() {

    delta_time= Date.now() - last_tick;
    last_tick = Date.now();
    tick_num++;


    updatePlayer(playerElm);

    for (orb of orbs) {
	orb.update()
    }


    window.requestAnimationFrame(tick);
  }


  const gameScale = 3;
  const tileSize = 16 * gameScale;


  // x and y are tile numbers 
  function placePlayer(x, y) {
    playerElm.style.top = (y) + "px";
    playerElm.style.left = (x) + "px";

  }


  let playerSpeed = .1;
  let playerKeyVelocity = {x : 0, y: 0};
  let pressedKeys = {
      up: false,
      down: false,
      left: false,
      right: false
  }
  function updatePlayer(playerElm) {
    let velocity = {x : 0, y: 0};

    // grab input
    if (pressedKeys.right) {
        velocity.x += playerSpeed * delta_time;
    }
    if (pressedKeys.left) {
        velocity.x -= playerSpeed * delta_time;
    }
    if (pressedKeys.up) {
        velocity.y -= playerSpeed * delta_time;
    }
    if (pressedKeys.down) {
        velocity.y += playerSpeed * delta_time;
    }

    // move player on screen
    player.x = player.x + velocity.x;
    player.y = player.y + velocity.y

    playerElm.style.left= `${player.x}px`;
    playerElm.style.top= `${player.y}px`;

    // animate
    // we're standing still
    if (Math.abs(velocity.x) + Math.abs(velocity.y) < 0.01) {
      switch(player.dir) {
        case "down":
	  playerElm.src = "player-facing-down.png";
          break;
        case "up":
	  playerElm.src = "player-facing-up.png";
          break;
        case "left":
	  playerElm.src = "player-facing-left.png";
          break;
        case "right":
	  playerElm.src = "player-facing-left.png";
	  playerElm.style.transform = "translate(-50%, -50%) scaleX(-1)";
          break;
      }
      
    // moving more vertical than horizontal
    } else if (Math.abs(velocity.y) > Math.abs(velocity.x)) {
      if (velocity.y > 0) {
	player.dir = "down";

        if ((Date.now() % 300) > 150) {
          playerElm.src = "player-walking-down.png";
        } else {
          playerElm.src = "player-facing-down.png";
        }
        playerElm.style.transform = "translate(-50%, -50%)";
      } else { // velocity.y < 0
	player.dir = "up";

        if ((Date.now() % 300) > 150) {
          playerElm.src = "player-walking-up.png";
        } else {
          playerElm.src = "player-facing-up.png";
        }
        playerElm.style.transform = "translate(-50%, -50%)";
      }
    }

    // moving more horizontal than vertical
    else {

      if (velocity.x > 0) {
	player.dir = "right";

        // animate
        if ((Date.now() % 300) > 150) {
          playerElm.src = "player-walking-left.png";
        } else {
          playerElm.src = "player-facing-left.png";
        }
        playerElm.style.transform = "translate(-50%, -50%) scaleX(-1)";
      } else { // velocity.x < 0
	player.dir = "left";

        if ((Date.now() % 300) > 150) {
          playerElm.src = "player-walking-left.png";
        } else {
          playerElm.src = "player-facing-left.png";
        }
        playerElm.style.transform = "translate(-50%, -50%)";
      }
    }


  }


  function updateScreenPos(elm, x, y) {
    elm.style.left = x + "px";
    elm.style.top = y + "px";
  }


  function randSound() {
    return sounds[Math.floor(Math.random() * sounds.length)];

  }


  let moveKeyPressed = false;
  function startGame() {

    //load bedroom
    //loadRoom("bedroom");

    // place player
    //placePlayer(300, 450);


    // init player
    player.x = 100;
    player.y = 150;
    playerElm.style.left = player.x + "px";
    playerElm.style.top = player.y + "px";

    // init orb "prefab"
    orbImage = new Image(16*3, 16*3);
    orbImage.src = "orb1.png";


    // start input
    window.addEventListener("mousedown", e => {
      
      // LEFT MOUSE BUTTON
      if (e.button == 0) {
	      target = {x: e.pageX, y: e.pageY};
      }

      // RIGHT MOUSE BUTTON
      if (e.button == 2) {
      }

    });

    window.addEventListener("mouseup", e => {

      // LEFT MOUSE BUTTON
      if (e.button == 0) {
      }

      if (e.button == 2) {
      }

    });

    window.addEventListener("mousemove", e => {
    });

    window.addEventListener("keyup", e => {
	switch(e.code) {
	  case "KeyS":
    	  case "ArrowDown":
	    pressedKeys.down = false;
    	    break;
    	  case "KeyW":
    	  case "ArrowUp":
	    pressedKeys.up = false;
    	    break;
    	  case "KeyA":
    	  case "ArrowLeft":
	    pressedKeys.left = false;
    	    break;
    	  case "KeyD":
    	  case "ArrowRight":
	    pressedKeys.right = false;
    	    break;
	}
    });
    window.addEventListener("keydown", e => {

	switch(e.code) {
	  case "KeyS":
    	  case "ArrowDown":
	    pressedKeys.down = true;
    	    break;
    	  case "KeyW":
    	  case "ArrowUp":
	    pressedKeys.up = true;
    	    break;
    	  case "KeyA":
    	  case "ArrowLeft":
	    pressedKeys.left = true;
    	    break;
    	  case "KeyD":
    	  case "ArrowRight":
	    pressedKeys.right = true;
    	    break;
    	  case "Space":

	    let vx = 0;
	    let vy = 0;

	    switch(player.dir) {
      	      case "down":
		vy = 1;
      	        break;
      	      case "up":
		vy = -1;
      	        break;
      	      case "left":
		vx = -1;
      	        break;
      	      case "right":
		vx = 1;
      	        break;
      	    }
	    

	    let orb = new Orb();

	    orb.x = player.x;
	    orb.y = player.y;
	    orb.vx = vx;
	    orb.vy = vy;

	    orbs.push(orb);

	    
    	    break;
	}

    });

    // disable context menu on right click
    window.addEventListener("contextmenu", e => e.preventDefault());

    window.addEventListener("dragend", e => {

    });




    window.requestAnimationFrame(tick);
  }
  


  startGame();

</script>
</body>


</html>
